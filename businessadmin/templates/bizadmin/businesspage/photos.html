{% extends 'bizadmin/index.html' %}
{% load static %}
{% load hosts %}
{% block java %}

<script>
    $(document).ready(function() {

                                $("#inputimage").change(function () {
                                  if (this.files && this.files[0]) {
                                      var reader = new FileReader();
                                      reader.onload = function (e) {
                                      $("#image").attr("src", e.target.result);
                                      $("#modalCrop").modal("show");
                                      }
                                      reader.readAsDataURL(this.files[0]);
                                  }
                                });
                                $("#inputtimage").change(function () {
                                  if (this.files && this.files[0]) {
                                      var reader = new FileReader();
                                      reader.onload = function (e) {
                                      $("#images").attr("src", e.target.result);
                                      $("#modalCropp").modal("show");
                                      }
                                      reader.readAsDataURL(this.files[0]);
                                  }
                                });

                                /* SCRIPTS TO HANDLE THE CROPPER BOX */
                                var $image = $("#image");
                                var $images = $("#images");
                                var cropBoxData;
                                var canvasData;
                                $("#modalCrop").on("shown.bs.modal", function () {
                                    $image.cropper("destroy");
                                    $image.cropper({
                                        viewMode: 1,
                                        aspectRatio: 16/9,
                                        minCropBoxWidth: 1600,
                                        minCropBoxHeight: 900,
                                        ready: function () {
                                            $image.cropper("setCanvasData", canvasData);
                                            $image.cropper("setCropBoxData", cropBoxData);
                                        }
                                    });
                                }).on("hidden.bs.modal", function () {
                                    cropBoxData = $image.cropper("getCropBoxData");
                                    canvasData = $image.cropper("getCanvasData");
                                    $image.cropper("destroy");
                                });

                                $("#modalCropp").on("shown.bs.modal", function () {
                                    $images.cropper("destroy");
                                    $images.cropper({
                                        viewMode: 1,
                                        aspectRatio: 16/9,
                                        minCropBoxWidth: 1600,
                                        minCropBoxHeight: 900,
                                        ready: function () {
                                            $images.cropper("setCanvasData", canvasData);
                                            $images.cropper("setCropBoxData", cropBoxData);
                                        }
                                    });
                                }).on("hidden.bs.modal", function () {
                                    cropBoxData = $images.cropper("getCropBoxData");
                                    canvasData = $images.cropper("getCanvasData");
                                    $images.cropper("destroy");
                                });

                                $(".js-zoom-in").click(function () {
                                    $image.cropper("zoom", 0.1);
                                });

                                $(".js-zoom-out").click(function () {
                                    $image.cropper("zoom", -0.1);
                                });

                                $(".js-zoom-ins").click(function () {
                                    $images.cropper("zoom", 0.1);
                                });

                                $(".js-zoom-outs").click(function () {
                                    $images.cropper("zoom", -0.1);
                                });

                                /* SCRIPT TO COLLECT THE DATA AND POST TO THE SERVER */
                                $(".js-crop-and-upload").click(function () {
                                    var cropData = $image.cropper("getData");
                                    $("#id_x").val(cropData["x"]);
                                    $("#id_y").val(cropData["y"]);
                                    $("#id_height").val(cropData["height"]);
                                    $("#id_width").val(cropData["width"]);
                                    $("#formUpload").submit();
                                });

                                /* SCRIPT TO COLLECT THE DATA AND POST TO THE SERVER */
                                $(".js-crop-and-uploads").click(function () {
                                    var cropDatas = $images.cropper("getData");
                                    console.log(cropDatas)
                                    $("#idd_x").val(cropDatas["x"]);
                                    $("#idd_y").val(cropDatas["y"]);
                                    $("#idd_height").val(cropDatas["height"]);
                                    $("#idd_width").val(cropDatas["width"]);
                                    $("#galUpload").submit();
                                });
                            });
</script>
{% endblock java %}
{% block businessadmin %}
<!-- Main page content-->
    <div class="content">
        <div class="row">
            <div class="col-md-10 ml-auto mr-auto">
                <header class="page-header page-header-compact page-header-light mb-4">
                    <div class="container">
                        <div class="page-header-content">
                            <div class="row align-items-center justify-content-between pt-3">
                                <div class="col-auto mb-3">
                                    <h1 class="page-header-title">
                                        Business Page - Photos and Gallery
                                    </h1>
                                </div>
                            </div>
                        </div>
                    </div>
                </header>
                <!-- Account page navigation-->
                <nav class="nav nav-borders">
                    <a class="nav-link activate ml-0" href="{% host_url 'photos' host 'bizadmin'%}">Photo and Gallery</a>
                    <a class="nav-link " href="{% host_url 'amenities' host 'bizadmin'%}">Amenities and Tags</a>
                </nav>
                <hr class="mt-0 mb-4" />
                <div class="row">
                    <div class="col-lg-4 mb-4">
                        <div class="card h-100 border-left-lg border-left-secondary">
                            <div class="card-header">Main Profile Photo</div>
                            <div class="card-body text-center">
                                <!-- Profile picture image-->
                                <img class="img-account-profile rounded-circle mb-2" src="{% if company.image %}{{ company.image.url }}{% else %}https://epicattorneymarketing.com/wp-content/uploads/2016/07/Headshot-Placeholder-1.png{% endif %}" alt="300x300" />
                                <!-- Profile picture help block-->
                                <div class="small font-italic text-muted mb-4">JPG or PNG no larger than 5 MB</div>
                                <!-- Profile picture upload button -->
                                <form action="{% host_url 'imageuploads' host 'bizadmin' %}" method="POST" enctype="multipart/form-data" id="formUpload">
                                    {% csrf_token %}
                                    <input type="hidden" name="x" id="id_x"><input type="hidden" name="y" id="id_y"><input type="hidden" name="width" id="id_width"><input type="hidden" name="height" id="id_height">
                                    <input type="file" id="inputimage" name="imageFile" class="btn btn-primary" accept="image/*" hidden >
                                    <button type="button" id="btnimage" name="imageFile" class="btn btn-primary">Upload new image</button>        
                                </form>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-8 mb-4">
                        <div class="card h-100 border-left-lg border-left-secondary">
                            <div class="card-header">Gallery Photos</div>
                            <div class="card-body text-center">
                                <!-- Gallary upload button -->
                                <form action="{% host_url 'galleryupload' host 'bizadmin' %}" method="POST" enctype="multipart/form-data" id="galUpload">
                                    {% csrf_token %}
                                    <input type="hidden" name="xs" id="idd_x"><input type="hidden" name="ys" id="idd_y"><input type="hidden" name="widths" id="idd_width"><input type="hidden" name="heights" id="idd_height">
                                    <input type="file" id="inputtimage" name="gallaryFile" class="btn btn-primary" accept="image/*" hidden >
                                    <button type="button" id="btnnimage" name="gallaryFile" class="btn btn-primary">Add a photo to your gallery</button>        
                                </form>
                                <div class="row" id="galphotos">
                                {% for p in photos %}
                                    <div class="col-sm-12 col-md-6 col-lg-4 mt-2">
                                        <div class="card hover-animate justify-content-center align-self-center show-image" id="{{ p.id }}">
                                            <img src="{{ p.photos.url }}" alt="">
                                            <a class="btn btn-danger d-none trashcan{{ p.id }} delete"><i class="fas fa-trash"></i></a>
                                        </div>
                                    </div>
                                {% endfor %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- MODAL TO CROP THE IMAGE -->
                        <div class="modal fade" id="modalCrop" data-backdrop="static" data-keyboard="false">
                            <div class="modal-dialog">
                                <div class="modal-content">
                                    <div class="modal-header">
                                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                        <span aria-hidden="true">&times;</span>
                                        </button>
                                        <h4 class="modal-title">Crop the photo</h4>
                                    </div>
                                    <div class="modal-body">
                                        <img src="" id="image" style="max-width: 100%;">
                                    </div>
                                    <div class="modal-footer">
                                        <div class="btn-group pull-left" role="group">
                                        <button type="button" class="btn btn-default js-zoom-in">
                                            <span class="fas fa-search-plus"></span>
                                        </button>
                                        <button type="button" class="btn btn-default js-zoom-out">
                                            <span class="fas fa-search-minus"></span>
                                        </button>
                                        </div>
                                        <button type="button" class="btn btn-default" data-dismiss="modal">Nevermind</button>
                                        <button type="button" class="btn btn-primary js-crop-and-upload">Crop and upload</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="modal fade" id="modalCropp" data-backdrop="static" data-keyboard="false">
                            <div class="modal-dialog">
                                <div class="modal-content">
                                    <div class="modal-header">
                                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                        <span aria-hidden="true">&times;</span>
                                        </button>
                                        <h4 class="modal-title">Crop the photo</h4>
                                    </div>
                                    <div class="modal-body">
                                        <img src="" id="images" style="max-width: 100%;">
                                    </div>
                                    <div class="modal-footer">
                                        <div class="btn-group pull-left" role="group">
                                        <button type="button" class="btn btn-default js-zoom-ins">
                                            <span class="fas fa-search-plus"></span>
                                        </button>
                                        <button type="button" class="btn btn-default js-zoom-outs">
                                            <span class="fas fa-search-minus"></span>
                                        </button>
                                        </div>
                                        <button type="button" class="btn btn-default" data-dismiss="modal">Nevermind</button>
                                        <button type="button" class="btn btn-primary js-crop-and-uploads">Crop and upload</button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <script>
                            document.getElementById('btnnimage').addEventListener('click', openDialog);

                            function openDialog() {
                                document.getElementById('inputtimage').click();
                            }
                        </script>

                        <script>
                            function getCookie(name) {
                            let cookieValue = null;
                            if (document.cookie && document.cookie !== '') {
                                const cookies = document.cookie.split(';');
                                for (let i = 0; i < cookies.length; i++) {
                                    const cookie = cookies[i].trim();
                                    // Does this cookie string begin with the name we want?
                                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                                        break;
                                    }
                                }
                            }
                                return cookieValue;
                            }
                            const csrftoken = getCookie('csrftoken');
            
                            document.getElementById('btnimage').addEventListener('click', openDialog);

                            function openDialog() {
                                document.getElementById('inputimage').click();
                            }
                            photo = document.querySelector("#galphotos");
                            {% for p in photos %}
                                $('#{{ p.id }}').hover(function(){
                                    $('.trashcan{{ p.id }}').toggleClass('d-none') 
                                });

                                $('.trashcan{{ p.id }}').click(function(){
                                    const swalStyles = Swal.mixin({
                                        customClass:{
                                            confirmButton: 'btn btn-primary',
                                            cancelButton: 'btn btn-danger',
                                        },
                                        buttonsStyling: false

                                    });
                                    swalStyles.fire({
                                        title: 'Are you sure you want to delete this picture from your gallery?',
                                        imageUrl: '{{ p.photos.url }}',
                                        icon: 'warning',
                                        showCancelButton: true,
                                        reverseButtons: true
                                    }).then((result) => {
                                        if (result.isConfirmed) {
                                            $.ajax({
                                                type:'POST',
                                                dataType: 'json',
                                                url: "{% host_url 'deletegalpic' host 'bizadmin' %}",
                                                data: JSON.stringify({pics_id: '{{ p.id }}'}),
                                                headers:{
                                                    "X-CSRFToken": csrftoken
                                                },
                                                cache: false,
                                            });
                                            
                                            swalStyles.fire({title: 'Gallery Picture Deleted!', text: 'Your file has been deleted.', icon: 'success' }).then(function(){ location.reload(); })
                                        } else if (
                                            /* Read more about handling dismissals below */
                                            result.dismiss === Swal.DismissReason.cancel
                                        ) {
                                            swalStyles.fire(
                                            'Cancelled',
                                            'Your gallery picture is safe! ðŸ˜Š',
                                            'error'
                                            )
                                        }
                                    });
                                });
                            {% endfor %}
                        </script>
{% endblock %}