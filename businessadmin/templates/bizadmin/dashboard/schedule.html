{% extends 'bizadmin/index.html' %}
{% load static %}
{% load hosts %}
{% block linkscript %}
    <link rel="stylesheet" href="{% static "css/calendarmain.css"%}">
    <script src="{% static "js/calendarmain.js" %}"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@10"></script>
{% endblock linkscript %}
{% block activecal%}active{%endblock%}
{% block businessadmin %}

<script>
    $('.datetimepicker').datetimepicker({
        format: 'LT',
        icons: {
        time: "fas fa-clock",
        up: "fa fa-chevron-up",
        down: "fa fa-chevron-down",
        previous: 'tim-icons icon-minimal-left',
        next: 'tim-icons icon-minimal-right',
        today: 'fa fa-screenshot',
        clear: 'fa fa-trash',
        close: 'fa fa-remove'
        }
    });
        document.addEventListener('DOMContentLoaded', function(){
                function getCookie(name) {
                    let cookieValue = null;
                    if (document.cookie && document.cookie !== '') {
                        const cookies = document.cookie.split(';');
                        for (let i = 0; i < cookies.length; i++) {
                            const cookie = cookies[i].trim();
                            // Does this cookie string begin with the name we want?
                            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                                break;
                            }
                        }
                    }
                        return cookieValue;
                }
                function gcd (a, b) {
                    return (b == 0) ? a : gcd (b, a%b);
                }

                function changeBooking(id) {
                    Swal.fire({
                        customClass:{
                            confirmButton: 'btn btn-primary',
                            denyButton: 'btn btn-danger',
                        },
                        buttonsStyling: false,
                        allowOutsideClick: false,
                        title: 'Reschedule service',
                        confirmButtonText: 'Reschedule',
                        showDenyButton: true,
                        denyButtonText: `Nevermind`,
                    });
                }

                function deleteBooking(id){
                    Swal.fire({
                        customClass:{
                            confirmButton: 'btn btn-primary',
                            denyButton: 'btn btn-danger',
                        },
                        buttonsStyling: false,
                        allowOutsideClick: false,
                        title: 'Are you sure you want to cancel this appointment?',
                        icon: 'warning',
                        confirmButtonText: 'Yes, Cancel',
                        showDenyButton: true,
                        denyButtonText: `No, I changed my mind`,
                    }).then(function(e){
                        const b_id = id
                        if (e.isConfirmed){
                            const csrftoken = getCookie('csrftoken');
                            $.ajax({
                                type: 'POST',
                                url: '{% host_url "delete_booking" host "bizadmin" %}',
                                data:{booking_id:b_id},
                                headers:{
                                    "X-CSRFToken": csrftoken
                                },
                                success: function(data){
                                    Swal.fire({
                                        customClass:{
                                            confirmButton: 'btn btn-primary',
                                            denyButton: 'btn btn-danger',
                                        },
                                        buttonsStyling: false,
                                        icon:'success',
                                        title:'This Booking has successfully been removed from your calendar.',
                                        html: 'We have informed your client about the cancellation.',
                                    });
                                },
                            });
                        }
                        else {
                            Swal.fire({
                                customClass:{
                                    confirmButton: 'btn btn-primary',
                                    denyButton: 'btn btn-danger',
                                },
                                buttonsStyling: false,
                                title:'We left your appointment alone.',
                            });
                        }
                    });
                }

                function showBookingDetail(data, id){
                    Swal.fire({
                        customClass:{
                            confirmButton: 'btn btn-primary',
                            denyButton: 'btn btn-danger',
                            cancelButton: 'btn',
                        },
                        buttonsStyling: false,
                        showDenyButton: true,
                        showCancelButton: true,
                        allowOutsideClick: false,
                        title: 'Appointment Details',
                        html: data.html_string,
                        confirmButtonText: 'Reschedule Appointment',
                        denyButtonText: `Cancel Booking`,
                        }).then(function(result){
                            if (result.isConfirmed){
                                changeBooking(id);
                            }
                            if (result.isDenied){
                                deleteBooking(id);
                            }
                        });
                }


                var w = screen.width;
                var h = screen.height;
                var r = gcd (w, h);
                var aspect = (w/r)/(h/r)/0.8

                if (w>768){
                    var rightitems = 'dayGridMonth,listWeek,listDay'
                    var initviewcal = 'dayGridMonth'
                }
                else{
                    var rightitems = 'listWeek,listDay'
                     var initviewcal = 'listWeek'
                }

                var leftitems = 'prev,next today'
                
               

                

                var asprat = aspect
                var calendarEl = document.getElementById('calendar');
                var calendar = new FullCalendar.Calendar(calendarEl, {
                    
                    buttonText: {
                        listWeek: 'Week',
                        listDay: 'Day',
                        dayGridMonth: 'Month'
                    },
                    selectable: true,
                aspectRatio: asprat,
                events:[
                {% for booking in bookings %}
                    {
                        title: 'Client: {{ booking.user.first_name}} Service: {{ booking.service.name }}',
                        start: '{{ booking.start|date:"Y-m-d" }}'+'T'+'{{ booking.start|date:"H:i:s" }}',
                        end: '{{ booking.end|date:"Y-m-d" }}'+'T'+'{{ booking.end|date:"H:i:s" }}',
                        id: '{{ booking.id }}',
                        className: 'event-green',
                        {% comment %} {% if forloop.counter|divisibleby:"2" %}
                            className: 'event-green',
                        {% elif forloop.counter|divisibleby:"3" %}
                            className: 'event-orange',
                        {% else %}
                            className:'event-red',
                        {% endif %} {% endcomment %}
                    },
                {% endfor %}
                ],
                eventRender: function(event, element) {                                          
                    element.find('span.fc-event-title').html(element.find('span.fc-event-title').text());                   

                },
                eventClick: function(info) {
                    const serv_id = info.event.id
                    $.ajax({
                        type: 'GET',
                        url: '{% host_url "getBookingId" host "bizadmin" %}',
                        data:{booking_id:serv_id},
                        success: function(data){
                            var name ='S'
                            showBookingDetail(data, serv_id)
                        },
                    })
                },
                noEventsClassNames: 'No bookings to display',
                initialView: initviewcal,
                headerToolbar: {
                    center: rightitems,
                    left: 'title',
                    right: leftitems
                },navLinks: true,
                navLinkDayClick: function(date, jsEvent) {
                    //When you click the day
                }
            });
            calendar.render()
        });
        
        $('body').on('click', 'button.fc-prev-button', function() {
            
        });
    </script>
        <!-- Main page content-->
        <div class="content">
        <div class="row">
        <div class="col-md-12 ml-auto mr-auto">
            <div class="card mx-auto">
            <div class="card-header">Schedule Manager</div>
            <div class="card-body">
                <button class="btn btn-primary" id="addbooking">Add A Booking</button>
            </div>

            <div class="card-body">

                <p>If you want to reschedule or delete a booking, go into the Agenda below, navigate to the date of the booking and click on the booking. </p>
            </div>
                
            </div>
        </div>
          <div class="col-md-12 ml-auto mr-auto">
            <div class="card card-calendar">
            <div class="card-header"></div>
              <div class="card-body">
                <div id="calendar"></div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <script>
        $(document).ready(function(e){
            $('#addbooking').on('click', function(){
                Swal.fire({
                    title: 'Add a booking',
                    html: `<p>Hello</p>`,

                }).then(function(e){
                    
                });
            });
        });
      </script>
{% endblock %}